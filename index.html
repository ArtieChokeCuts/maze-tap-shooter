<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Super Eva's Magic Bus Ride</title>
    <style>
        /* --- CORE STYLES --- */
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-user-select: none; }
        body { 
            overflow: hidden; 
            background: #fdf2f8; /* Soft Pink Base */
            font-family: "Comic Sans MS", "Trebuchet MS", sans-serif; 
            touch-action: none; 
        }

        /* --- UI LAYER (The HUD) --- */
        #ui-layer {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
        }

        /* Frosted Glass Panels */
        .glass-panel {
            background: rgba(255, 255, 255, 0.35);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-radius: 20px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
            width: 100px;
            transition: all 0.3s ease;
        }

        .panel-label {
            font-weight: 900;
            font-size: 1.2rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            text-shadow: 0 2px 4px rgba(255,255,255,0.8);
        }

        /* Liquid Progress Bars */
        .bar-container {
            width: 24px;
            height: 150px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .liquid {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%; /* Dynamic Height */
            transition: height 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Left Panel (Letters) */
        #panel-left { color: #d63384; }
        #bar-left .liquid { background: linear-gradient(to top, #d63384, #ff6fae); }

        /* Right Panel (Numbers) */
        #panel-right { color: #198754; opacity: 0.5; /* Dimmed until unlocked */ }
        #bar-right .liquid { background: linear-gradient(to top, #198754, #20c997); }

        /* --- CENTER STARS (The Targets) --- */
        #top-center {
            position: absolute;
            top: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
            pointer-events: none;
            z-index: 11;
        }

        .star-box {
            position: relative;
            width: 110px;
            height: 110px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: float 3s ease-in-out infinite;
        }

        .star-shape {
            position: absolute;
            font-size: 110px;
            filter: drop-shadow(0 4px 10px rgba(0,0,0,0.2));
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .star-content {
            position: relative;
            z-index: 2;
            font-size: 1.8rem;
            font-weight: 900;
            color: white;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.3);
            text-align: center;
            line-height: 1;
        }

        /* Left Star (Yellow/Gold) */
        #star-left .star-shape { color: #ffc107; -webkit-text-stroke: 4px #b8860b; }
        
        /* Right Star (Orange) */
        #star-right .star-shape { color: #fd7e14; -webkit-text-stroke: 4px #c2410c; }
        #star-right { display: none; /* Hidden until Eva is found */ }

        /* --- SPLASH SCREEN --- */
        #splash-screen {
            position: fixed; inset: 0; z-index: 100;
            background: url("splash.png") center center / cover no-repeat;
            background-color: #87ceeb; /* Fallback */
            display: flex; align-items: center; justify-content: center;
        }
        #start-btn {
            padding: 20px 50px; font-size: 2rem; font-weight: 900;
            color: #5c3d00; background: #ffe44d; border: 4px solid #fff;
            border-radius: 50px; cursor: pointer;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            animation: pulse 1.5s infinite;
        }

        /* Animations */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }
        
        .pop-anim { animation: popIn 0.4s forwards; }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-6px, 0, 0); } 40%, 60% { transform: translate3d(6px, 0, 0); } }

        canvas { display: block; position: absolute; inset: 0; }
        #helper { position: absolute; bottom: 10px; width: 100%; text-align: center; color: #666; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div id="splash-screen">
        <button id="start-btn">PLAY!</button>
    </div>

    <div id="top-center">
        <div id="star-left" class="star-box">
            <div class="star-shape">★</div>
            <div class="star-content" id="target-word">EVA</div>
        </div>
        <div id="star-right" class="star-box">
            <div class="star-shape">★</div>
            <div class="star-content" id="target-num">25</div>
        </div>
    </div>

    <div id="ui-layer">
        <div style="display:flex; justify-content:space-between; width:100%;">
            <div id="panel-left" class="glass-panel">
                <div class="panel-label">Letters</div>
                <div class="bar-container"><div id="bar-left" class="liquid"></div></div>
            </div>

            <div id="panel-right" class="glass-panel">
                <div class="panel-label">Numbers</div>
                <div class="bar-container"><div id="bar-right" class="liquid"></div></div>
            </div>
        </div>
        <div id="helper">Tap the bubbles in order!</div>
    </div>

    <canvas id="webgl"></canvas>

    <script src="three.min.js"></script>
    <script>
        // --- GAME STATE ---
        const state = {
            playing: false,
            levelLetters: 0,
            levelNumbers: 0,
            targetWord: "EVA", // First Word ALWAYS
            targetNum: "25",
            wordIndex: 0, // Current letter progress (0 = needs first letter)
            numbersUnlocked: false,
            wordList: ["IAN", "ASA", "MAMA", "POP", "ART", "CAT", "DOG", "BUS"], // Pool after EVA
            numberList: ["5", "10", "15", "20", "25", "50", "100"]
        };

        // --- AUDIO ---
        const audio = {
            bg: new Audio('loop.mp3'),
            theme: new Audio('eva_theme.mp3'),
            pop: new Audio('pop.mp3'),
            magic: new Audio('magic.mp3')
        };
        audio.bg.loop = true;
        audio.bg.volume = 0.4;
        audio.theme.volume = 1.0; 

        // --- THREE.JS SETUP ---
        let scene, camera, renderer, busGroup, wandTip;
        const bubbles = [];
        const particles = [];
        let bubbleLabels = "E V A I N S M O P 1 2 3 4 5".split(" "); // Initial pool

        function init() {
            if (!window.THREE) {
                console.error('Three.js failed to load.');
                return;
            }
            // Scene
            const canvas = document.querySelector('#webgl');
            renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

            scene = new THREE.Scene();
            // Gradient Sky Mesh
            const skyGeo = new THREE.SphereGeometry(40, 32, 32);
            const skyMat = new THREE.MeshBasicMaterial({ color: 0xffe6f2, side: THREE.BackSide }); 
            scene.add(new THREE.Mesh(skyGeo, skyMat));

            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 100);
            camera.position.set(0, 0, 5);

            // Lights
            const ambient = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambient);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
            dirLight.position.set(5, 10, 7);
            scene.add(dirLight);

            // The Bus & Eva
            busGroup = new THREE.Group();
            scene.add(busGroup);

            // Eva Sprite
            const loader = new THREE.TextureLoader();
            loader.load('eva.png', (tex) => {
                const mat = new THREE.SpriteMaterial({ map: tex });
                const sprite = new THREE.Sprite(mat);
                sprite.scale.set(1.5, 1.5, 1);
                busGroup.add(sprite);
            });

            // Wand Tip (Invisible target for sparkles)
            wandTip = new THREE.Mesh(new THREE.SphereGeometry(0.1), new THREE.MeshBasicMaterial({ visible: false }));
            wandTip.position.set(0.5, 0.5, 0);
            busGroup.add(wandTip);

            // Initial Bubbles
            for(let i=0; i<15; i++) spawnBubble();

            // Events
            window.addEventListener('resize', onResize);
            window.addEventListener('pointerdown', onTap);
            document.getElementById('start-btn').addEventListener('click', startGame);
            
            animate();
        }

        function spawnBubble(recycleBubble = null) {
            const bubble = recycleBubble || new THREE.Mesh(
                new THREE.SphereGeometry(0.4, 32, 32),
                new THREE.MeshStandardMaterial({
                    color: 0xffffff, roughness: 0.1, metalness: 0.1,
                    transparent: true, opacity: 0.6
                })
            );

            // Pick a label
            // Hint Logic: If we need "E", spawn more "E"s
            let char;
            if (Math.random() < 0.4) {
                // 40% chance to spawn exactly what we need
                char = state.targetWord[state.wordIndex];
            } else if (state.numbersUnlocked && Math.random() < 0.3) {
                 // 30% chance for number
                char = state.targetNum;
            } else {
                // Random junk
                const pool = "ABCDEFGHIJKLMNOPQRSTUVWXYZ123456789";
                char = pool[Math.floor(Math.random() * pool.length)];
            }

            // Create Text Sprite
            if (bubble.userData.sprite) bubble.remove(bubble.userData.sprite);
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.font = "bold 80px Comic Sans MS";
            ctx.fillStyle = "#6b4fc7";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(char, 64, 64);
            const tex = new THREE.CanvasTexture(canvas);
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex }));
            sprite.scale.set(0.6, 0.6, 1);
            bubble.add(sprite);
            
            // Random Position
            const x = (Math.random() - 0.5) * 6;
            const y = -4 - Math.random() * 5; // Start below screen
            const z = (Math.random() - 0.5) * 2;
            bubble.position.set(x, y, z);
            
            bubble.userData = { 
                label: char, 
                sprite: sprite, 
                speed: 0.02 + Math.random() * 0.03,
                wobble: Math.random() * Math.PI 
            };

            if (!recycleBubble) {
                scene.add(bubble);
                bubbles.push(bubble);
            }
        }

        function startGame() {
            document.getElementById('splash-screen').style.display = 'none';
            state.playing = true;
            audio.bg.play().catch(e => console.log("Audio needs interaction"));
            updateHUD();
        }

        function onTap(e) {
            if (!state.playing) return;
            
            // Raycast
            const mouse = new THREE.Vector2();
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);
            
            const intersects = raycaster.intersectObjects(bubbles);
            if (intersects.length > 0) {
                const hit = intersects[0].object;
                popBubble(hit);
            }
        }

        function popBubble(bubble) {
            const char = bubble.userData.label;
            
            // 1. Play Sound
            audio.pop.currentTime = 0;
            audio.pop.play();

            // 2. Logic Check
            let correct = false;

            // CHECK WORD LOGIC (Strict Mode)
            const neededLetter = state.targetWord[state.wordIndex];
            
            if (char === neededLetter) {
                // Correct Letter!
                correct = true;
                state.wordIndex++;
                
                // Visual Feedback
                document.getElementById('target-word').style.color = "#00ff00"; // Flash Green
                setTimeout(() => document.getElementById('target-word').style.color = "white", 200);

                // Word Complete?
                if (state.wordIndex >= state.targetWord.length) {
                    triggerWin("WORD");
                }
            } else if (state.numbersUnlocked && char === state.targetNum) {
                // Correct Number!
                correct = true;
                triggerWin("NUMBER");
            } else {
                // WRONG HIT -> PENALTY
                // Reset Word Progress
                if (state.wordIndex > 0) {
                    state.wordIndex = 0; // Hard Reset
                    const wordEl = document.getElementById('target-word');
                    wordEl.classList.add('shake');
                    wordEl.style.color = "red";
                    setTimeout(() => {
                        wordEl.classList.remove('shake');
                        wordEl.style.color = "white";
                    }, 500);
                }
            }

            // 3. Reset Bubble Position
            spawnBubble(bubble); 
            
            // 4. Update UI
            updateHUD();
        }

        function triggerWin(type) {
            // STOP BG, PLAY THEME
            audio.bg.pause();
            audio.theme.currentTime = 0;
            audio.theme.play();
            
            // Resume BG after theme (assuming 10s clip, adjust as needed)
            setTimeout(() => {
                if(state.playing) audio.bg.play();
            }, 8000);

            // Confetti / Particles (Simple JS Burst)
            createParticles();

            if (type === "WORD") {
                state.levelLetters++;
                document.getElementById('bar-left').style.height = (state.levelLetters * 10) + "%";
                
                // FIRST WIN UNLOCK
                if (state.targetWord === "EVA" && !state.numbersUnlocked) {
                    state.numbersUnlocked = true;
                    document.getElementById('star-right').style.display = 'flex';
                    document.getElementById('panel-right').style.opacity = "1";
                    document.getElementById('target-word').innerText = "UNLOCKED!";
                }

                // Pick New Word
                state.wordIndex = 0;
                setTimeout(() => {
                    const next = state.wordList[Math.floor(Math.random() * state.wordList.length)];
                    state.targetWord = next;
                    updateHUD();
                }, 1500);
            } 
            else if (type === "NUMBER") {
                state.levelNumbers++;
                document.getElementById('bar-right').style.height = (state.levelNumbers * 10) + "%";
                
                // Pick New Number
                setTimeout(() => {
                    const next = state.numberList[Math.floor(Math.random() * state.numberList.length)];
                    state.targetNum = next;
                    updateHUD();
                }, 1000);
            }
        }

        function createParticles() {
            // Add DOM particles for simple "Confetti"
            for(let i=0; i<30; i++) {
                const p = document.createElement('div');
                p.style.position = 'fixed';
                p.style.left = '50%';
                p.style.top = '50%';
                p.style.width = '10px';
                p.style.height = '10px';
                p.style.backgroundColor = ['#ff0', '#f0f', '#0ff'][Math.floor(Math.random()*3)];
                p.style.borderRadius = '50%';
                p.style.transition = 'transform 1s ease-out, opacity 1s';
                document.body.appendChild(p);
                
                setTimeout(() => {
                    const x = (Math.random() - 0.5) * window.innerWidth;
                    const y = (Math.random() - 0.5) * window.innerHeight;
                    p.style.transform = `translate(${x}px, ${y}px) scale(0)`;
                    p.style.opacity = 0;
                }, 10);
                setTimeout(() => p.remove(), 1000);
            }
        }

        function updateHUD() {
            // Update Center Stars
            const wLabel = document.getElementById('target-word');
            // Show letters collected so far? Or just the target?
            // "EVA" -> User has "E" -> Show "E _ _" ? 
            // Let's stick to showing the GOAL, but highlight progress color?
            // Simple approach: Show Goal.
            wLabel.innerText = state.targetWord;
            
            // If strict mode, maybe underline the next letter needed?
            // Advanced: wLabel.innerHTML = `<span style="color:#0f0">${state.targetWord.substring(0, state.wordIndex)}</span>${state.targetWord.substring(state.wordIndex)}`;
             
             let html = "";
             for(let i=0; i<state.targetWord.length; i++) {
                 if (i < state.wordIndex) html += `<span style="color:#ffff00; text-shadow:0 0 10px gold">${state.targetWord[i]}</span>`; // Found
                 else if (i === state.wordIndex) html += `<span style="color:#fff; text-decoration:underline">${state.targetWord[i]}</span>`; // Needed
                 else html += `<span style="opacity:0.5">${state.targetWord[i]}</span>`; // Future
             }
             wLabel.innerHTML = html;

            document.getElementById('target-num').innerText = state.targetNum;
        }

        function animate() {
            requestAnimationFrame(animate);

            const time = performance.now() * 0.001;

            if (state.playing) {
                // Move Bubbles
                bubbles.forEach(b => {
                    b.position.y += b.userData.speed;
                    b.position.x += Math.sin(time + b.userData.wobble) * 0.002;
                    
                    // Respawn if too high
                    if (b.position.y > 6) {
                        spawnBubble(b);
                    }
                });

                // Float Bus
                if (busGroup) {
                    busGroup.position.y = Math.sin(time * 1.5) * 0.1;
                    busGroup.rotation.z = Math.sin(time * 0.5) * 0.02;
                }
            }

            renderer.render(scene, camera);
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
