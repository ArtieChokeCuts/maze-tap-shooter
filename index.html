<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Super Eva's Magic Bus Ride</title>
    <style>
        /* --- CORE STYLES --- */
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-user-select: none; }
        body { 
            overflow: hidden; 
            background: #87ceeb; /* Open Sky */
            font-family: "Comic Sans MS", "Trebuchet MS", sans-serif; 
            touch-action: none; 
        }

        /* Neon HUD Dashboard */
        #hud-overlay {
            position: absolute;
            inset: 0;
            z-index: 100;
            pointer-events: none;
            display: flex;
            justify-content: space-between;
            padding: 20px;
        }

        .neon-panel {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid;
            box-shadow: 0 0 15px currentColor;
            padding: 15px 18px;
            border-radius: 12px;
            min-width: 120px;
            text-align: center;
            font-weight: 800;
        }

        #math-panel { border-color: #00f3ff; color: #00f3ff; } /* Blue Neon */
        #word-panel { border-color: #ff00ff; color: #ff00ff; } /* Pink Neon */

        /* --- UI LAYER (The HUD) --- */
        #ui-layer {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 20;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
        }

        /* Frosted Glass Panels */
        .glass-panel {
            background: rgba(255, 255, 255, 0.35);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-radius: 20px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
            width: 100px;
            transition: all 0.3s ease;
        }

        .panel-label {
            font-weight: 900;
            font-size: 1.2rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            text-shadow: 0 2px 4px rgba(255,255,255,0.8);
        }

        /* Liquid Progress Bars */
        .bar-container {
            width: 24px;
            height: 150px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .liquid {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%; /* Dynamic Height */
            transition: height 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Left Panel (Letters) */
        #panel-left { color: #d63384; }
        #bar-left .liquid { background: linear-gradient(to top, #d63384, #ff6fae); }

        /* Right Panel (Numbers) */
        #panel-right { color: #198754; opacity: 0.5; /* Dimmed until unlocked */ }
        #bar-right .liquid { background: linear-gradient(to top, #198754, #20c997); }

        /* --- CENTER STARS (The Targets) --- */
        #top-center {
            position: absolute;
            top: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
            pointer-events: none;
            z-index: 21;
        }

        .star-box {
            position: relative;
            width: min(240px, 45vw);
            height: min(240px, 45vw);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: float 3s ease-in-out infinite;
        }

        .star-shape {
            position: absolute;
            font-size: min(240px, 45vw);
            filter: drop-shadow(0 4px 10px rgba(0,0,0,0.2));
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .star-content {
            position: relative;
            z-index: 2;
            font-size: 2.5rem;
            font-weight: 900;
            color: white;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.3);
            text-align: center;
            line-height: 1;
        }

        .star-sub {
            position: absolute;
            bottom: -18px;
            font-size: 0.85rem;
            font-weight: 800;
            color: #5c3d00;
            background: rgba(255, 255, 255, 0.75);
            padding: 4px 10px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 6px 16px rgba(31, 38, 135, 0.1);
        }

        /* Left Star (Yellow/Gold) */
        #star-left .star-shape { color: #ffc107; -webkit-text-stroke: 6px #b8860b; }
        
        /* Right Star (Orange) */
        #star-right .star-shape { color: #fd7e14; -webkit-text-stroke: 6px #c2410c; }
        #star-right { display: none; /* Hidden until Eva is found */ }

        /* --- SPLASH SCREEN --- */
        #splash-screen {
            position: fixed; inset: 0; z-index: 100;
            background: url("splash.png") center center / cover no-repeat;
            background-color: #87ceeb; /* Fallback */
            display: flex; align-items: center; justify-content: center;
        }
        #start-btn {
            padding: 20px 50px; font-size: 2rem; font-weight: 900;
            color: #5c3d00; background: #ffe44d; border: 4px solid #fff;
            border-radius: 50px; cursor: pointer;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            animation: pulse 1.5s infinite;
        }

        /* Animations */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }
        @keyframes sparkle {
            0% { transform: translate(0, 0) scale(0.2); opacity: 1; }
            100% { transform: translate(var(--spark-x), var(--spark-y)) scale(1); opacity: 0; }
        }
        @keyframes popupFloat {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            20% { transform: translate(-50%, -60%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -120%) scale(0.6); opacity: 0; }
        }
        
        .pop-anim { animation: popIn 0.4s forwards; }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-6px, 0, 0); } 40%, 60% { transform: translate3d(6px, 0, 0); } }

        canvas { display: block; position: absolute; inset: 0; z-index: 5; }
        #bottom-ui {
            position: absolute;
            bottom: 10px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        #word-bank {
            padding: 10px 16px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.9);
            font-weight: 800;
            color: #6b4fc7;
            text-align: center;
            box-shadow: 0 8px 20px rgba(31, 38, 135, 0.1);
        }

        #word-bank .bank-title {
            display: block;
            font-size: 0.9rem;
            color: #d63384;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        #word-bank .bank-word {
            display: inline-block;
            margin: 0 6px;
            padding: 4px 10px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.7);
        }

        #word-bank .bank-word.active {
            background: #ffe44d;
            color: #5c3d00;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        #number-bank-list {
            margin-top: 6px;
        }

        #letter-bank-list {
            margin-top: 6px;
        }

        #number-bank-list .bank-word {
            background: rgba(255, 255, 255, 0.8);
            color: #198754;
        }

        #letter-bank-list .bank-word {
            background: rgba(255, 255, 255, 0.85);
            color: #6b4fc7;
        }

        #helper { text-align: center; color: #666; font-size: 0.9rem; }

        #magic-layer {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 30;
        }

        .sparkle {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: radial-gradient(circle, #fff 0%, #ffe44d 60%, transparent 100%);
            animation: sparkle 0.7s ease-out forwards;
        }

        .magic-popup {
            position: absolute;
            font-size: 4rem;
            font-weight: 900;
            color: #ff6fae;
            text-shadow: 0 0 12px rgba(255, 255, 255, 0.9), 0 4px 12px rgba(0,0,0,0.25);
            animation: popupFloat 0.9s ease-out forwards;
        }
    </style>
</head>
<body>

    <div id="splash-screen">
        <button id="start-btn">START GAME</button>
    </div>

    <div id="hud-overlay">
        <div id="math-panel" class="neon-panel">
            <div>Math Score</div>
            <div id="math-score">0</div>
        </div>
        <div id="word-panel" class="neon-panel">
            <div>Word Score</div>
            <div id="word-score">0</div>
        </div>
    </div>

    <div id="top-center">
        <div id="star-left" class="star-box">
            <div class="star-shape">★</div>
            <div class="star-content" id="target-word">EVA</div>
            <div class="star-sub" id="word-progress"></div>
        </div>
        <div id="star-right" class="star-box">
            <div class="star-shape">★</div>
            <div class="star-content" id="target-num">25</div>
            <div class="star-sub" id="number-progress"></div>
        </div>
    </div>

    <div id="ui-layer">
        <div style="display:flex; justify-content:space-between; width:100%;">
            <div id="panel-left" class="glass-panel">
                <div class="panel-label">Letters</div>
                <div class="bar-container"><div id="bar-left" class="liquid"></div></div>
            </div>

            <div id="panel-right" class="glass-panel">
                <div class="panel-label">Numbers</div>
                <div class="bar-container"><div id="bar-right" class="liquid"></div></div>
            </div>
        </div>
        <div id="bottom-ui">
            <div id="word-bank">
                <span class="bank-title">Word Bank · <span id="level-indicator">Level 1</span></span>
                <div id="word-bank-list"></div>
                <div id="letter-bank-list"></div>
                <div id="number-bank-list"></div>
            </div>
            <div id="helper">Tap a bubble to pop it with your magic wand!</div>
        </div>
    </div>

    <canvas id="webgl"></canvas>
    <div id="magic-layer"></div>

    <script src="three.min.js"></script>
    <script>
        // --- GAME STATE ---
        const state = {
            playing: false,
            level: 1,
            levelProgress: 0,
            levelLetters: 0,
            levelNumbers: 0,
            targetWord: "EVA", // First Word ALWAYS
            targetNum: "25",
            wordIndex: 0, // Current letter progress (0 = needs first letter)
            numberSum: 0,
            numbersUnlocked: false,
            wordList: ["IAN", "ASA", "MAMA", "POP", "ART", "CAT", "DOG", "BUS"], // Pool after EVA
            numberList: ["5", "10", "15", "20", "25", "50", "100"],
            numberPool: Array.from({ length: 20 }, (_, idx) => String(idx + 1)),
            letterPool: []
        };

        const recentLetters = [];
        const recentNumbers = [];

        const levelConfigs = [
            { id: 1, goal: 3, bubbleCount: 14, speedZ: 0.028, speedY: 0.002, wobble: 0.004 },
            { id: 2, goal: 4, bubbleCount: 18, speedZ: 0.038, speedY: 0.004, wobble: 0.005 },
            { id: 3, goal: 5, bubbleCount: 22, speedZ: 0.048, speedY: 0.006, wobble: 0.006 }
        ];

        // --- AUDIO ---
        const audio = {
            bg: new Audio('loop.mp3'),
            theme: new Audio('eva_theme.mp3'),
            pop: new Audio('pop.mp3'),
            magic: new Audio('magic.mp3')
        };
        const bgBaseVolume = 0.4;
        audio.bg.loop = true;
        audio.bg.volume = bgBaseVolume;
        audio.theme.volume = 1.0; 

        // --- THREE.JS SETUP ---
        let scene, camera, renderer, busGroup, wandTip;
        const bubbles = [];
        const particles = [];
        const clouds = [];
        let bubbleLabels = "E V A I N S M O P 1 2 3 4 5".split(" "); // Initial pool
        let lastTapPosition = { x: window.innerWidth / 2, y: window.innerHeight / 2 };

        function init() {
            if (!window.THREE) {
                console.error('Three.js failed to load.');
                return;
            }
            state.letterPool = buildLetterPool();
            // Scene
            const canvas = document.querySelector('#webgl');
            renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

            scene = new THREE.Scene();
            // Gradient Sky Mesh
            const skyGeo = new THREE.SphereGeometry(40, 32, 32);
            const skyMat = new THREE.MeshBasicMaterial({ color: 0x87ceeb, side: THREE.BackSide }); 
            scene.add(new THREE.Mesh(skyGeo, skyMat));

            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 100);
            camera.position.set(0, 0, 5);

            // Lights
            const ambient = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambient);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
            dirLight.position.set(5, 10, 7);
            scene.add(dirLight);

            // The Bus & Eva
            busGroup = new THREE.Group();
            scene.add(busGroup);

            // Neon Bus Sprite (asset-free)
            const busCanvas = document.createElement('canvas');
            busCanvas.width = 256;
            busCanvas.height = 128;
            const busCtx = busCanvas.getContext('2d');
            drawNeonBus(busCtx);
            const busTexture = new THREE.CanvasTexture(busCanvas);
            const busMaterial = new THREE.SpriteMaterial({ map: busTexture, transparent: true });
            const busSprite = new THREE.Sprite(busMaterial);
            busSprite.scale.set(2.2, 1.1, 1);
            busGroup.add(busSprite);

            // Wand Tip (Invisible target for sparkles)
            wandTip = new THREE.Mesh(new THREE.SphereGeometry(0.1), new THREE.MeshBasicMaterial({ visible: false }));
            wandTip.position.set(0.5, 0.5, 0);
            busGroup.add(wandTip);

            // Initial Bubbles
            applyLevelConfig();
            createClouds();

            // Events
            window.addEventListener('resize', onResize);
            window.addEventListener('pointerdown', onTap);
            document.getElementById('start-btn').addEventListener('click', startGame);
            
            animate();
        }

        function spawnBubble(recycleBubble = null) {
            const bubble = recycleBubble || new THREE.Mesh(
                new THREE.SphereGeometry(0.4, 32, 32),
                new THREE.MeshStandardMaterial({
                    color: 0xffffff, roughness: 0.1, metalness: 0.1,
                    transparent: true, opacity: 0.6
                })
            );

            // Pick a label
            // Hint Logic: If we need "E", spawn more "E"s
            let char;
            if (Math.random() < 0.35) {
                // Spawn what we need for the word
                char = state.targetWord[state.wordIndex];
            } else if (Math.random() < 0.3) {
                // Spawn a number
                char = state.numberPool[Math.floor(Math.random() * state.numberPool.length)];
            } else {
                // Random letter from the alphabet pool
                const pool = state.letterPool.length ? state.letterPool : ["E", "V", "A"];
                char = pool[Math.floor(Math.random() * pool.length)];
            }

            // Create Text Sprite
            if (bubble.userData.sprite) bubble.remove(bubble.userData.sprite);
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.font = "bold 80px Comic Sans MS";
            ctx.fillStyle = "#6b4fc7";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(char, 64, 64);
            const tex = new THREE.CanvasTexture(canvas);
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex }));
            sprite.scale.set(0.6, 0.6, 1);
            bubble.add(sprite);
            
            // Random Position (float toward Eva)
            const x = (Math.random() - 0.5) * 7;
            const y = (Math.random() - 0.5) * 4;
            const z = -6 - Math.random() * 4;
            bubble.position.set(x, y, z);
            
            const config = getLevelConfig();
            bubble.userData = { 
                label: char, 
                sprite: sprite, 
                speedZ: config.speedZ + Math.random() * 0.02,
                speedY: config.speedY + Math.random() * 0.01,
                wobble: Math.random() * Math.PI,
                wobbleSpeed: 0.6 + Math.random() * 0.6
            };

            if (!recycleBubble) {
                scene.add(bubble);
                bubbles.push(bubble);
            }
        }

        function startGame() {
            document.getElementById('splash-screen').style.display = 'none';
            state.playing = true;
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(() => {});
            }
            audio.bg.play().catch(e => console.log("Audio needs interaction"));
            updateHUD();
        }

        function onTap(e) {
            if (!state.playing) return;
            lastTapPosition = { x: e.clientX, y: e.clientY };
            
            // Raycast
            const mouse = new THREE.Vector2();
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);
            
            const intersects = raycaster.intersectObjects(bubbles);
            if (intersects.length > 0) {
                const hit = intersects[0].object;
                popBubble(hit, lastTapPosition);
            }
        }

        function popBubble(bubble, tapPosition) {
            const char = bubble.userData.label;
            
            // 1. Play Sound
            audio.pop.currentTime = 0;
            audio.pop.play();
            audio.magic.currentTime = 0;
            audio.magic.play();
            createMagicBurst(tapPosition.x, tapPosition.y, char);

            // 2. Logic Check
            let correct = false;
            const numberValue = parseInt(char, 10);

            if (state.numbersUnlocked && !Number.isNaN(numberValue)) {
                // Number Logic: Add up to the target
                state.numberSum += numberValue;
                correct = true;
                trackSequence(recentNumbers, numberValue, true);

                if (state.numberSum > Number(state.targetNum)) {
                    state.numberSum = 0;
                    const numEl = document.getElementById('target-num');
                    numEl.classList.add('shake');
                    numEl.style.color = "red";
                    setTimeout(() => {
                        numEl.classList.remove('shake');
                        numEl.style.color = "white";
                    }, 500);
                } else if (state.numberSum === Number(state.targetNum)) {
                    triggerWin("NUMBER");
                }
            } else {
                if (!state.numbersUnlocked && !Number.isNaN(numberValue)) {
                    spawnBubble(bubble);
                    updateHUD();
                    return;
                }
                // CHECK WORD LOGIC (Strict Mode)
                const neededLetter = state.targetWord[state.wordIndex];
                
                if (char === neededLetter) {
                    // Correct Letter!
                    correct = true;
                    state.wordIndex++;
                    trackSequence(recentLetters, char, false);
                    
                    // Visual Feedback
                    document.getElementById('target-word').style.color = "#00ff00"; // Flash Green
                    setTimeout(() => document.getElementById('target-word').style.color = "white", 200);

                    // Word Complete?
                    if (state.wordIndex >= state.targetWord.length) {
                        triggerWin("WORD");
                    }
                } else {
                    // WRONG HIT -> PENALTY
                    // Reset Word Progress
                    if (state.wordIndex > 0) {
                        state.wordIndex = 0; // Hard Reset
                        const wordEl = document.getElementById('target-word');
                        wordEl.classList.add('shake');
                        wordEl.style.color = "red";
                        if (navigator.vibrate) {
                            navigator.vibrate(200);
                        }
                        setTimeout(() => {
                            wordEl.classList.remove('shake');
                            wordEl.style.color = "white";
                        }, 500);
                    }
                }
            }

            // 3. Reset Bubble Position
            spawnBubble(bubble); 
            
            // 4. Update UI
            updateHUD();
        }

        function triggerWin(type) {
            const isEvaWin = type === "WORD" && state.targetWord === "EVA";
            if (isEvaWin) {
                // Smoothly fade out the loop before the anthem
                const fadeOut = setInterval(() => {
                    if (audio.bg.volume > 0.05) {
                        audio.bg.volume -= 0.05;
                        return;
                    }
                    audio.bg.volume = 0;
                    audio.bg.pause();
                    clearInterval(fadeOut);
                    audio.theme.currentTime = 0;
                    audio.theme.play();
                }, 50);
            }
            
            // Confetti / Particles (Simple JS Burst)
            createParticles();
            state.numberSum = 0;
            state.wordIndex = 0;

            // Resume BG after theme
            if (isEvaWin) {
                setTimeout(() => {
                    if (state.playing) {
                        audio.bg.volume = bgBaseVolume;
                        audio.bg.play();
                    }
                }, 8000);
            }

            if (type === "WORD") {
                state.levelLetters++;
                document.getElementById('bar-left').style.height = (state.levelLetters * 10) + "%";
                
                // FIRST WIN UNLOCK
                if (state.targetWord === "EVA" && !state.numbersUnlocked) {
                    state.numbersUnlocked = true;
                    state.numberSum = 0;
                    document.getElementById('star-right').style.display = 'flex';
                    document.getElementById('panel-right').style.opacity = "1";
                    document.getElementById('target-word').innerText = "UNLOCKED!";
                }

                // Pick New Word
                state.wordIndex = 0;
                setTimeout(() => {
                    const next = state.wordList[Math.floor(Math.random() * state.wordList.length)];
                    state.targetWord = next;
                    updateHUD();
                }, 1500);
            } 
            else if (type === "NUMBER") {
                state.levelNumbers++;
                document.getElementById('bar-right').style.height = (state.levelNumbers * 10) + "%";
                state.numberSum = 0;
                
                // Pick New Number
                setTimeout(() => {
                    const next = state.numberList[Math.floor(Math.random() * state.numberList.length)];
                    state.targetNum = next;
                    updateHUD();
                }, 1000);
            }

            state.levelProgress++;
            checkLevelUp();
        }

        function createParticles() {
            // Add DOM particles for simple "Confetti"
            for(let i=0; i<30; i++) {
                const p = document.createElement('div');
                p.style.position = 'fixed';
                p.style.left = '50%';
                p.style.top = '50%';
                p.style.width = '10px';
                p.style.height = '10px';
                p.style.backgroundColor = ['#ff0', '#f0f', '#0ff'][Math.floor(Math.random()*3)];
                p.style.borderRadius = '50%';
                p.style.transition = 'transform 1s ease-out, opacity 1s';
                document.body.appendChild(p);
                
                setTimeout(() => {
                    const x = (Math.random() - 0.5) * window.innerWidth;
                    const y = (Math.random() - 0.5) * window.innerHeight;
                    p.style.transform = `translate(${x}px, ${y}px) scale(0)`;
                    p.style.opacity = 0;
                }, 10);
                setTimeout(() => p.remove(), 1000);
            }
        }

        function updateHUD() {
            // Update Center Stars
            const wLabel = document.getElementById('target-word');
            // Show letters collected so far? Or just the target?
            // "EVA" -> User has "E" -> Show "E _ _" ? 
            // Let's stick to showing the GOAL, but highlight progress color?
            // Simple approach: Show Goal.
            wLabel.innerText = state.targetWord;
            
            // If strict mode, maybe underline the next letter needed?
            // Advanced: wLabel.innerHTML = `<span style="color:#0f0">${state.targetWord.substring(0, state.wordIndex)}</span>${state.targetWord.substring(state.wordIndex)}`;
             
             let html = "";
             for(let i=0; i<state.targetWord.length; i++) {
                 if (i < state.wordIndex) html += `<span style="color:#ffff00; text-shadow:0 0 10px gold">${state.targetWord[i]}</span>`; // Found
                 else if (i === state.wordIndex) html += `<span style="color:#fff; text-decoration:underline">${state.targetWord[i]}</span>`; // Needed
                 else html += `<span style="opacity:0.5">${state.targetWord[i]}</span>`; // Future
             }
             wLabel.innerHTML = html;

            document.getElementById('target-num').innerText = state.targetNum;
            updateWordBank();
            updateHelperText();
            updateStarProgress();
        }

        function updateWordBank() {
            const listEl = document.getElementById('word-bank-list');
            const bank = ["EVA", ...state.wordList];
            listEl.innerHTML = bank.map((word) => {
                const isActive = word === state.targetWord;
                return `<span class="bank-word ${isActive ? "active" : ""}">${word}</span>`;
            }).join("");

            const letterBank = document.getElementById('letter-bank-list');
            const letterLabel = state.letterPool.length ? state.letterPool : ["E", "V", "A"];
            letterBank.innerHTML = letterLabel.map((letter) => `<span class="bank-word">${letter}</span>`).join("");

            const numberBank = document.getElementById('number-bank-list');
            numberBank.innerHTML = state.numberPool.map((num) => `<span class="bank-word">${num}</span>`).join("");
        }

        function updateNeonHUD() {
            const mathScore = document.getElementById('math-score');
            const wordScore = document.getElementById('word-score');
            if (mathScore) mathScore.innerText = state.levelNumbers;
            if (wordScore) wordScore.innerText = state.levelLetters;
        }

        function updateHelperText() {
            const levelEl = document.getElementById('level-indicator');
            if (levelEl) {
                levelEl.innerText = `Level ${state.level}`;
            }
            const config = getLevelConfig();
            const helper = document.getElementById('helper');
            helper.innerText = `Tap a bubble to pop it with your magic wand! ${state.levelProgress}/${config.goal} wins to level up.`;
        }

        function updateStarProgress() {
            const wordProgress = document.getElementById('word-progress');
            const built = state.targetWord.slice(0, state.wordIndex);
            const remaining = "_".repeat(Math.max(state.targetWord.length - state.wordIndex, 0));
            wordProgress.innerText = `${built}${remaining}`;

            const numProgress = document.getElementById('number-progress');
            if (state.numbersUnlocked) {
                numProgress.innerText = `Sum: ${state.numberSum} / ${state.targetNum}`;
            } else {
                numProgress.innerText = "Locked";
            }
        }

        function buildLetterPool() {
            return "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
        }

        function drawNeonBus(ctx) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.fillStyle = "rgba(0,0,0,0)";
            ctx.strokeStyle = "#ff00ff";
            ctx.lineWidth = 6;
            ctx.shadowColor = "#ff00ff";
            ctx.shadowBlur = 15;
            ctx.strokeRect(20, 30, 200, 70);

            ctx.shadowBlur = 8;
            ctx.strokeStyle = "#00f3ff";
            ctx.strokeRect(40, 45, 50, 25);
            ctx.strokeRect(100, 45, 50, 25);

            ctx.shadowBlur = 12;
            ctx.beginPath();
            ctx.arc(60, 110, 12, 0, Math.PI * 2);
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(160, 110, 12, 0, Math.PI * 2);
            ctx.stroke();
        }

        function trackSequence(sequence, value, isNumber) {
            sequence.push(value);
            if (sequence.length > 3) sequence.shift();
            if (sequence.length < 3) return;

            const isRun = sequence.every((val, idx) => {
                if (idx === 0) return true;
                if (isNumber) {
                    return val === sequence[idx - 1] + 1;
                }
                return val.charCodeAt(0) === sequence[idx - 1].charCodeAt(0) + 1;
            });

            if (isRun) {
                triggerJackpotEffect();
            }
        }

        function triggerJackpotEffect() {
            createParticles();
            const helper = document.getElementById('helper');
            helper.classList.add('pop-anim');
            helper.innerText = "JACKPOT!";
            setTimeout(() => {
                helper.classList.remove('pop-anim');
                updateHelperText();
            }, 1200);
        }

        function createMagicBurst(x, y, char) {
            const layer = document.getElementById('magic-layer');
            if (!layer) return;

            const popup = document.createElement('div');
            popup.className = 'magic-popup';
            popup.style.left = `${x}px`;
            popup.style.top = `${y}px`;
            popup.style.color = ['#ff6fae', '#6b4fc7', '#20c997'][Math.floor(Math.random() * 3)];
            popup.textContent = char;
            layer.appendChild(popup);

            for (let i = 0; i < 14; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.style.left = `${x}px`;
                sparkle.style.top = `${y}px`;
                sparkle.style.background = `radial-gradient(circle, #fff 0%, ${['#ffe44d', '#ff6fae', '#20c997'][Math.floor(Math.random() * 3)]} 60%, transparent 100%)`;
                sparkle.style.setProperty('--spark-x', `${(Math.random() - 0.5) * 160}px`);
                sparkle.style.setProperty('--spark-y', `${(Math.random() - 0.5) * 160}px`);
                layer.appendChild(sparkle);
                setTimeout(() => sparkle.remove(), 800);
            }
            setTimeout(() => popup.remove(), 900);
        }

        function getLevelConfig() {
            return levelConfigs[Math.min(state.level - 1, levelConfigs.length - 1)];
        }

        function applyLevelConfig() {
            const config = getLevelConfig();
            ensureBubbleCount(config.bubbleCount);
            updateHUD();
        }

        function ensureBubbleCount(targetCount) {
            while (bubbles.length < targetCount) {
                spawnBubble();
            }
        }

        function checkLevelUp() {
            const config = getLevelConfig();
            if (state.levelProgress < config.goal) {
                return;
            }
            if (state.level < levelConfigs.length) {
                state.level += 1;
                state.levelProgress = 0;
                applyLevelConfig();
            }
        }

        function createCloudTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 256;
            canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = "rgba(255,255,255,0.85)";
            ctx.beginPath();
            ctx.ellipse(70, 70, 50, 30, 0, 0, Math.PI * 2);
            ctx.ellipse(120, 55, 60, 40, 0, 0, Math.PI * 2);
            ctx.ellipse(170, 70, 55, 35, 0, 0, Math.PI * 2);
            ctx.fill();
            const tex = new THREE.CanvasTexture(canvas);
            tex.needsUpdate = true;
            return tex;
        }

        function createClouds() {
            const texture = createCloudTexture();
            for (let i = 0; i < 6; i++) {
                const material = new THREE.SpriteMaterial({ map: texture, transparent: true, opacity: 0.9 });
                const cloud = new THREE.Sprite(material);
                cloud.scale.set(3.5 + Math.random() * 2, 1.8 + Math.random(), 1);
                cloud.position.set((Math.random() - 0.5) * 12, 1 + Math.random() * 4, -8 - Math.random() * 4);
                cloud.userData = {
                    speedX: 0.002 + Math.random() * 0.004
                };
                scene.add(cloud);
                clouds.push(cloud);
            }
        }

        function animate() {
            requestAnimationFrame(animate);

            const time = performance.now() * 0.001;

            if (state.playing) {
                const targetCount = getLevelConfig().bubbleCount;
                if (bubbles.length < targetCount) {
                    ensureBubbleCount(targetCount);
                }
                // Move Bubbles
                bubbles.forEach(b => {
                    b.position.z += b.userData.speedZ;
                    b.position.y += b.userData.speedY;
                    b.position.x += Math.sin(time * b.userData.wobbleSpeed + b.userData.wobble) * 0.004;
                    
                    // Respawn if too close or too high
                    if (b.position.z > 5.5 || b.position.y > 6) {
                        spawnBubble(b);
                    }
                });

                // Move Clouds
                clouds.forEach(c => {
                    c.position.x += c.userData.speedX;
                    if (c.position.x > 8) {
                        c.position.x = -8;
                    }
                });

                // Float Bus
                if (busGroup) {
                    busGroup.position.y = Math.sin(time * 1.5) * 0.1;
                    busGroup.rotation.z = Math.sin(time * 0.5) * 0.02;
                }
            }

            renderer.render(scene, camera);
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
